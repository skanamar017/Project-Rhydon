<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Team Manager</title>
</head>
<body>
    <h1>Pokemon Team Manager</h1>
    
    <div>
        <h2>Team Selection</h2>
        <select id="teamSelect">
            <option value="">Select a team...</option>
        </select>
        <button onclick="loadTeams()">Refresh Teams</button>
    </div>
    
    <div id="teamDetails" style="display: none;">
        <h3 id="teamName">Team Name</h3>
        <div id="teamPokemon"></div>
        
        <h3>Pokemon Editor</h3>
        <div id="pokemonDetails" style="display: none;">
            <div>
                <label>Nickname: <input type="text" id="pokemonNickname"></label><br><br>
                <label>Level: <input type="number" id="pokemonLevel" min="1" max="100"></label><br><br>
                <label>Status: 
                    <select id="pokemonStatus">
                        <option value="Healthy">Healthy</option>
                        <option value="Poisoned">Poisoned</option>
                        <option value="Burned">Burned</option>
                        <option value="Frozen">Frozen</option>
                        <option value="Paralyzed">Paralyzed</option>
                        <option value="Asleep">Asleep</option>
                    </select>
                </label><br><br>
                <label>Current HP: <input type="number" id="pokemonHP" min="1"></label><br><br>
            </div>
            
            <h4>Individual Values (IVs) - Read Only</h4>
            <div>
                Attack: <span id="iv_attack_display">0</span><br>
                Defense: <span id="iv_defense_display">0</span><br>
                Speed: <span id="iv_speed_display">0</span><br>
                Special: <span id="iv_special_display">0</span><br>
                HP (calculated): <span id="iv_hp_display">0</span><br>
            </div>
            
            <h4>Effort Values (EVs)</h4>
            <div>
                HP: <input type="number" id="ev_hp" min="0" max="65535" value="0"><br>
                Attack: <input type="number" id="ev_attack" min="0" max="65535" value="0"><br>
                Defense: <input type="number" id="ev_defense" min="0" max="65535" value="0"><br>
                Speed: <input type="number" id="ev_speed" min="0" max="65535" value="0"><br>
                Special: <input type="number" id="ev_special" min="0" max="65535" value="0"><br>
                <button onclick="resetEVs()">Reset EVs</button>
                <button onclick="maxEVs()">Max EVs</button>
            </div>
            
            <h4>Calculated Stats</h4>
            <div id="calculatedStatsDisplay">
                HP: <span id="calc_hp">-</span><br>
                Attack: <span id="calc_attack">-</span><br>
                Defense: <span id="calc_defense">-</span><br>
                Speed: <span id="calc_speed">-</span><br>
                Special: <span id="calc_special">-</span><br>
            </div>
            
            <h4>Moves</h4>
            <div id="movesDisplay"></div>
            <button onclick="openMoveManager()">Manage Moves</button>
            
            <div style="margin-top: 20px;">
                <button onclick="saveChanges()">Save Changes</button>
                <button onclick="cancelChanges()">Cancel</button>
            </div>
            
            <div id="messageArea"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://127.0.0.1:5001';
        let currentTeamId = null;
        let currentPokemonId = null;
        let currentPokemon = null;
        
        async function loadTeams() {
            try {
                const response = await fetch(`${BASE_URL}/Teams/`);
                const teams = await response.json();
                
                const teamSelect = document.getElementById('teamSelect');
                teamSelect.innerHTML = '<option value="">Select a team...</option>';
                
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teams:', error);
                showMessage('Error loading teams: ' + error.message, 'error');
            }
        }
        
        async function loadTeamDetails(teamId) {
            if (!teamId) {
                document.getElementById('teamDetails').style.display = 'none';
                return;
            }
            
            try {
                currentTeamId = teamId;
                
                const teamResponse = await fetch(`${BASE_URL}/Teams/${teamId}`);
                const team = await teamResponse.json();
                document.getElementById('teamName').textContent = team.name;
                
                const pokemonResponse = await fetch(`${BASE_URL}/Teams/${teamId}/TeamPokemon/`);
                const pokemon = await pokemonResponse.json();
                
                displayTeamPokemon(pokemon);
                document.getElementById('teamDetails').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading team details:', error);
                showMessage('Error loading team details: ' + error.message, 'error');
            }
        }
        
        function displayTeamPokemon(pokemon) {
            const container = document.getElementById('teamPokemon');
            container.innerHTML = '';
            
            if (pokemon.length === 0) {
                container.innerHTML = '<p>No Pokemon on this team.</p>';
                return;
            }
            
            pokemon.forEach(p => {
                const div = document.createElement('div');
                div.style.border = '1px solid #ddd';
                div.style.padding = '10px';
                div.style.margin = '5px';
                div.style.cursor = 'pointer';
                div.onclick = () => selectPokemon(p);
                
                div.innerHTML = `
                    <strong>${p.nickname || p.pokemon_name}</strong> (${p.pokemon_name}) - Level ${p.level}<br>
                    Type: ${p.type1}${p.type2 ? `/${p.type2}` : ''}<br>
                    HP: ${p.calculated_hp || p.current_hp} | Status: ${p.status}
                `;
                
                container.appendChild(div);
            });
        }
        
        function selectPokemon(pokemon) {
            document.querySelectorAll('#teamPokemon div').forEach(div => {
                div.style.backgroundColor = '';
            });
            
            event.currentTarget.style.backgroundColor = '#d4edda';
            
            currentPokemon = pokemon;
            currentPokemonId = pokemon.id;
            
            loadPokemonEditor(pokemon);
        }
        
        function loadPokemonEditor(pokemon) {
            document.getElementById('pokemonNickname').value = pokemon.nickname || '';
            document.getElementById('pokemonLevel').value = pokemon.level;
            document.getElementById('pokemonStatus').value = pokemon.status || 'Healthy';
            document.getElementById('pokemonHP').value = pokemon.current_hp || '';
            
            document.getElementById('iv_attack_display').textContent = pokemon.iv_attack || 0;
            document.getElementById('iv_defense_display').textContent = pokemon.iv_defense || 0;
            document.getElementById('iv_speed_display').textContent = pokemon.iv_speed || 0;
            document.getElementById('iv_special_display').textContent = pokemon.iv_special || 0;
            
            const hpIV = ((pokemon.iv_attack % 2) * 8) + ((pokemon.iv_defense % 2) * 4) + ((pokemon.iv_speed % 2) * 2) + (pokemon.iv_special % 2);
            document.getElementById('iv_hp_display').textContent = hpIV;
            
            document.getElementById('ev_hp').value = pokemon.ev_hp || 0;
            document.getElementById('ev_attack').value = pokemon.ev_attack || 0;
            document.getElementById('ev_defense').value = pokemon.ev_defense || 0;
            document.getElementById('ev_speed').value = pokemon.ev_speed || 0;
            document.getElementById('ev_special').value = pokemon.ev_special || 0;
            
            updateCalculatedStats();
            loadMoves(pokemon);
            
            document.getElementById('pokemonDetails').style.display = 'block';
        }
        
        function loadMoves(pokemon) {
            const container = document.getElementById('movesDisplay');
            const moves = [
                { id: pokemon.move1_id, slot: 1 },
                { id: pokemon.move2_id, slot: 2 },
                { id: pokemon.move3_id, slot: 3 },
                { id: pokemon.move4_id, slot: 4 }
            ];
            
            container.innerHTML = '';
            
            moves.forEach(async (moveSlot) => {
                const div = document.createElement('div');
                div.style.padding = '5px';
                div.style.border = '1px solid #ccc';
                div.style.margin = '2px';
                
                if (moveSlot.id) {
                    try {
                        const response = await fetch(`${BASE_URL}/moves/${moveSlot.id}`);
                        const move = await response.json();
                        div.innerHTML = `${move.name} (${move.type}) - Power: ${move.power || '-'}, PP: ${move.pp}`;
                    } catch (error) {
                        div.innerHTML = 'Error loading move';
                    }
                } else {
                    div.innerHTML = 'Empty move slot';
                    div.style.fontStyle = 'italic';
                }
                
                container.appendChild(div);
            });
        }
        
        function updateCalculatedStats() {
            if (!currentPokemon) return;
            
            if (currentPokemon.calculated_hp !== undefined) {
                document.getElementById('calc_hp').textContent = currentPokemon.calculated_hp;
                document.getElementById('calc_attack').textContent = currentPokemon.calculated_attack;
                document.getElementById('calc_defense').textContent = currentPokemon.calculated_defense;
                document.getElementById('calc_speed').textContent = currentPokemon.calculated_speed;
                document.getElementById('calc_special').textContent = currentPokemon.calculated_special;
                return;
            }
            
            const level = parseInt(document.getElementById('pokemonLevel').value) || 1;
            const ivs = {
                attack: parseInt(document.getElementById('iv_attack_display').textContent) || 0,
                defense: parseInt(document.getElementById('iv_defense_display').textContent) || 0,
                speed: parseInt(document.getElementById('iv_speed_display').textContent) || 0,
                special: parseInt(document.getElementById('iv_special_display').textContent) || 0
            };
            const evs = {
                hp: parseInt(document.getElementById('ev_hp').value) || 0,
                attack: parseInt(document.getElementById('ev_attack').value) || 0,
                defense: parseInt(document.getElementById('ev_defense').value) || 0,
                speed: parseInt(document.getElementById('ev_speed').value) || 0,
                special: parseInt(document.getElementById('ev_special').value) || 0
            };
            
            const hpIV = ((ivs.attack % 2) * 8) + ((ivs.defense % 2) * 4) + ((ivs.speed % 2) * 2) + (ivs.special % 2);
            
            const baseStats = {
                hp: currentPokemon.base_hp || 50,
                attack: currentPokemon.base_attack || 50,
                defense: currentPokemon.base_defense || 50,
                speed: currentPokemon.base_speed || 50,
                special: currentPokemon.base_special || 50
            };
            
            const calculatedStats = {
                hp: Math.floor(((baseStats.hp + hpIV) * 2 + Math.floor(Math.sqrt(evs.hp) / 4)) * level / 100) + level + 10,
                attack: Math.floor(((baseStats.attack + ivs.attack) * 2 + Math.floor(Math.sqrt(evs.attack) / 4)) * level / 100) + 5,
                defense: Math.floor(((baseStats.defense + ivs.defense) * 2 + Math.floor(Math.sqrt(evs.defense) / 4)) * level / 100) + 5,
                speed: Math.floor(((baseStats.speed + ivs.speed) * 2 + Math.floor(Math.sqrt(evs.speed) / 4)) * level / 100) + 5,
                special: Math.floor(((baseStats.special + ivs.special) * 2 + Math.floor(Math.sqrt(evs.special) / 4)) * level / 100) + 5
            };
            
            document.getElementById('calc_hp').textContent = calculatedStats.hp;
            document.getElementById('calc_attack').textContent = calculatedStats.attack;
            document.getElementById('calc_defense').textContent = calculatedStats.defense;
            document.getElementById('calc_speed').textContent = calculatedStats.speed;
            document.getElementById('calc_special').textContent = calculatedStats.special;
        }
        
        function resetEVs() {
            document.getElementById('ev_hp').value = 0;
            document.getElementById('ev_attack').value = 0;
            document.getElementById('ev_defense').value = 0;
            document.getElementById('ev_speed').value = 0;
            document.getElementById('ev_special').value = 0;
            updateCalculatedStats();
        }
        
        function maxEVs() {
            document.getElementById('ev_hp').value = 65535;
            document.getElementById('ev_attack').value = 65535;
            document.getElementById('ev_defense').value = 65535;
            document.getElementById('ev_speed').value = 65535;
            document.getElementById('ev_special').value = 65535;
            updateCalculatedStats();
        }
        
        async function saveChanges() {
            if (!currentPokemonId) {
                showMessage('No Pokemon selected', 'error');
                return;
            }
            
            try {
                const updateData = {
                    nickname: document.getElementById('pokemonNickname').value,
                    level: parseInt(document.getElementById('pokemonLevel').value),
                    status: document.getElementById('pokemonStatus').value,
                    current_hp: parseInt(document.getElementById('pokemonHP').value),
                    ev_hp: parseInt(document.getElementById('ev_hp').value),
                    ev_attack: parseInt(document.getElementById('ev_attack').value),
                    ev_defense: parseInt(document.getElementById('ev_defense').value),
                    ev_speed: parseInt(document.getElementById('ev_speed').value),
                    ev_special: parseInt(document.getElementById('ev_special').value)
                };
                
                const response = await fetch(`${BASE_URL}/Teams/${currentTeamId}/TeamPokemon/${currentPokemonId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    showMessage('Pokemon updated successfully!', 'success');
                    loadTeamDetails(currentTeamId);
                } else {
                    const error = await response.json();
                    showMessage('Error updating Pokemon: ' + error.error, 'error');
                }
                
            } catch (error) {
                console.error('Error saving changes:', error);
                showMessage('Error saving changes: ' + error.message, 'error');
            }
        }
        
        function cancelChanges() {
            if (currentPokemon) {
                loadPokemonEditor(currentPokemon);
                showMessage('Changes cancelled', 'success');
            }
        }
        
        function openMoveManager() {
            window.open('move_manager.html', '_blank');
        }
        
        function showMessage(message, type) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div style="color: ${type === 'error' ? 'red' : 'green'}; margin-top: 10px;">${message}</div>`;
            
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }
        
        document.getElementById('teamSelect').addEventListener('change', function() {
            loadTeamDetails(this.value);
        });
        
        ['pokemonLevel', 'ev_hp', 'ev_attack', 'ev_defense', 'ev_speed', 'ev_special'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateCalculatedStats);
        });
        
        loadTeams();
    </script>
</body>
</html>
