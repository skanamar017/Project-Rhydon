<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Pokemon Team Manager - Test</title>
</head>
<body>
    <h1>Pokemon Team Manager - Basic Test Frontend</h1>
    
    <h2>Register</h2>
    <form id="registerForm">
        <label for="registerUsername">Username:</label>
        <input type="text" id="registerUsername" required>
        <label for="registerPassword">Password:</label>
        <input type="password" id="registerPassword" required>
        <button type="submit">Register</button>
    </form>
    <div id="registerResult"></div>
    <hr>
    
    <h2>Login</h2>
    <form id="loginForm">
        <label for="loginUsername">Username:</label>
        <input type="text" id="loginUsername" required>
        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" required>
        <button type="submit">Login</button>
    </form>
    <div id="loginResult"></div>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <div id="currentUser"></div>
    <hr>
    
    <h2>Create New Team</h2>
    <form id="createTeamForm">
        <label for="teamName">Team Name:</label>
        <input type="text" id="teamName" name="teamName" required>
        <button type="submit">Create Team</button>
    </form>
    <div id="createTeamResult"></div>
    
    <hr>
    
    <h2>Add Pokemon to Team</h2>
    <form id="addPokemonForm">
        <label for="teamSelect">Select Team:</label>
        <select id="teamSelect" name="teamSelect" required>
            <option value="">Choose a team</option>
        </select>
        <br><br>
        
        <label for="pokemonSelect">Select Pokemon:</label>
        <select id="pokemonSelect" name="pokemonSelect" required>
            <option value="">Choose a Pokemon</option>
        </select>
        <br><br>
        
        <label for="pokemonLevel">Level (1-100):</label>
        <input type="number" id="pokemonLevel" name="pokemonLevel" min="1" max="100" value="50" required>
        <br><br>
        
        <label for="pokemonNickname">Nickname (optional):</label>
        <input type="text" id="pokemonNickname" name="pokemonNickname">
        <br><br>
        
        <button type="submit">Add Pokemon</button>
    </form>
    <div id="addPokemonResult"></div>
    
    <hr>
    
    <h2>Teams</h2>
    <button id="refreshTeams">Refresh Teams</button>
    <div id="teamsDisplay"></div>
    
    <hr>
    
    <h2>Debug Information</h2>
    <button id="testConnection">Test API Connection</button>
    <div id="debugInfo"></div>

    <script>
        const API_BASE = 'http://127.0.0.1:5001';
        
        document.addEventListener('DOMContentLoaded', function() {
            loadTeams();
            loadPokemonList();
            setupEventListeners();
            showCurrentUser();
        });

        function setupEventListeners() {
            document.getElementById('createTeamForm').addEventListener('submit', handleCreateTeam);
            document.getElementById('addPokemonForm').addEventListener('submit', handleAddPokemon);
            document.getElementById('refreshTeams').addEventListener('click', loadTeams);
            document.getElementById('testConnection').addEventListener('click', testConnection);
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('registerForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('registerUsername').value;
                const password = document.getElementById('registerPassword').value;
                const resultDiv = document.getElementById('registerResult');
                try {
                    const res = await fetch(`${API_BASE}/user/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        resultDiv.innerHTML = 'Registration successful! You are now logged in.';
                        document.getElementById('logoutBtn').style.display = '';
                        showCurrentUser();
                    } else {
                        resultDiv.innerHTML = 'Registration failed: ' + (data.error || res.status);
                    }
                } catch (e) {
                    resultDiv.innerHTML = 'Registration error: ' + e.message;
                }
            });
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, { ...options, credentials: 'include' });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const resultDiv = document.getElementById('loginResult');
            
            if (!username || !password) {
                resultDiv.innerHTML = 'Error: Please enter both username and password';
                return;
            }

            try {
                const response = await makeRequest(`${API_BASE}/user/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                resultDiv.innerHTML = 'Login successful!';
                document.getElementById('logoutBtn').style.display = '';
                showCurrentUser();
                loadTeams();
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
            }
        }

        async function handleLogout() {
            const resultDiv = document.getElementById('loginResult');
            
            try {
                await fetch(`${API_BASE}/user/logout`, { method: 'POST', credentials: 'include' });

                resultDiv.innerHTML = 'Success: Logged out';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('currentUser').innerHTML = '';
                loadTeams();
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
            }
        }

        async function showCurrentUser() {
            try {
                const res = await fetch(`${API_BASE}/user/me`, { credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('currentUser').innerHTML = 'Logged in as: ' + data.username;
                }
            } catch {}
        }

        async function handleCreateTeam(event) {
            event.preventDefault();
            const teamName = document.getElementById('teamName').value.trim();
            const resultDiv = document.getElementById('createTeamResult');
            
            if (!teamName) {
                resultDiv.innerHTML = 'Error: Please enter a team name';
                return;
            }

            try {
                const team = await makeRequest(`${API_BASE}/Teams/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: teamName })
                });

                resultDiv.innerHTML = `Success: Team "${team.name}" created with ID ${team.id}`;
                document.getElementById('teamName').value = '';
                loadTeams();
                updateTeamSelect();
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
            }
        }

        async function handleAddPokemon(event) {
            event.preventDefault();
            const teamId = document.getElementById('teamSelect').value;
            const pokemonId = document.getElementById('pokemonSelect').value;
            const level = document.getElementById('pokemonLevel').value;
            const nickname = document.getElementById('pokemonNickname').value.trim();
            const resultDiv = document.getElementById('addPokemonResult');

            if (!teamId || !pokemonId || !level) {
                resultDiv.innerHTML = 'Error: Please select team, pokemon, and enter level';
                return;
            }

            try {
                const pokemon = {
                    pokemon_id: parseInt(pokemonId),
                    level: parseInt(level),
                    nickname: nickname || null
                };

                await makeRequest(`${API_BASE}/Teams/${teamId}/TeamPokemon/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pokemon)
                });

                resultDiv.innerHTML = 'Success: Pokemon added to team!';
                document.getElementById('pokemonLevel').value = '50';
                document.getElementById('pokemonNickname').value = '';
                loadTeams();
            } catch (error) {
                resultDiv.innerHTML = `Error: ${error.message}`;
            }
        }

        async function loadTeams() {
            const container = document.getElementById('teamsDisplay');
            
            try {
                const teams = await makeRequest(`${API_BASE}/Teams/`);
                
                if (teams.length === 0) {
                    container.innerHTML = '<p>No teams found. Create a team to get started!</p>';
                    return;
                }

                let html = '<h3>Current Teams:</h3>';
                for (const team of teams) {
                    const pokemon = await loadTeamPokemon(team.id);
                    const count = await getTeamPokemonCount(team.id);
                    
                    html += `
                        <div>
                            <h4>${team.name} (ID: ${team.id})</h4>
                            <p>Pokemon Count: ${count.pokemon_count}/6</p>
                            <ul>
                                ${pokemon.map(p => `
                                    <li>
                                        ${p.nickname || p.pokemon_name} (${p.pokemon_name}) - Level ${p.level}
                                        <br>HP: ${p.calculated_hp} | ATK: ${p.calculated_attack} | DEF: ${p.calculated_defense} | SPD: ${p.calculated_speed} | SPC: ${p.calculated_special}
                                        <br>
                                        <button onclick="removePokemon(${team.id}, ${p.id})" ${!count.can_remove ? 'disabled' : ''}>Remove</button>
                                    </li>
                                `).join('')}
                            </ul>
                            <button onclick="deleteTeam(${team.id})">Delete Team</button>
                            <hr>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                updateTeamSelect();
                
            } catch (error) {
                container.innerHTML = `Error loading teams: ${error.message}`;
            }
        }

        async function loadTeamPokemon(teamId) {
            try {
                return await makeRequest(`${API_BASE}/Teams/${teamId}/TeamPokemon/`);
            } catch (error) {
                return [];
            }
        }

        async function getTeamPokemonCount(teamId) {
            try {
                return await makeRequest(`${API_BASE}/Teams/${teamId}/TeamPokemon/count`);
            } catch (error) {
                return { pokemon_count: 0, can_add_more: true, can_remove: false };
            }
        }

        async function loadPokemonList() {
            try {
                const pokemon = await makeRequest(`${API_BASE}/Pokemon/`);
                const select = document.getElementById('pokemonSelect');
                
                select.innerHTML = '<option value="">Choose a Pokemon</option>';
                pokemon.forEach(p => {
                    select.innerHTML += `<option value="${p.pokedex_number}">${p.name} (#${p.pokedex_number})</option>`;
                });
            } catch (error) {
                document.getElementById('pokemonSelect').innerHTML = '<option value="">Error loading Pokemon</option>';
            }
        }

        async function updateTeamSelect() {
            try {
                const teams = await makeRequest(`${API_BASE}/Teams/`);
                const select = document.getElementById('teamSelect');
                
                select.innerHTML = '<option value="">Choose a team</option>';
                teams.forEach(team => {
                    select.innerHTML += `<option value="${team.id}">${team.name}</option>`;
                });
            } catch (error) {
                console.error('Error updating team select:', error);
            }
        }

        async function removePokemon(teamId, pokemonId) {
            if (!confirm('Are you sure you want to remove this Pokemon?')) {
                return;
            }

            try {
                await makeRequest(`${API_BASE}/Teams/${teamId}/TeamPokemon/${pokemonId}`, {
                    method: 'DELETE'
                });

                loadTeams();
            } catch (error) {
                alert(`Error removing Pokemon: ${error.message}`);
            }
        }

        async function deleteTeam(teamId) {
            if (!confirm('Are you sure you want to delete this team?')) {
                return;
            }

            try {
                await makeRequest(`${API_BASE}/Teams/${teamId}`, {
                    method: 'DELETE'
                });

                loadTeams();
                updateTeamSelect();
            } catch (error) {
                alert(`Error deleting team: ${error.message}`);
            }
        }

        async function testConnection() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = 'Testing API connection...';
            
            try {
                const response = await makeRequest(`${API_BASE}/`);
                debugDiv.innerHTML = `
                    <h4>API Connection Test Results:</h4>
                    <p>✅ Connection successful!</p>
                    <p>Response: ${JSON.stringify(response)}</p>
                    <p>API Base URL: ${API_BASE}</p>
                `;
            } catch (error) {
                debugDiv.innerHTML = `
                    <h4>API Connection Test Results:</h4>
                    <p>❌ Connection failed!</p>
                    <p>Error: ${error.message}</p>
                    <p>API Base URL: ${API_BASE}</p>
                    <p>Make sure your Flask server is running on port 5001</p>
                `;
            }
        }
    </script>
</body>
</html>
